From 3b83c24287a951b49fdf323f6262acae5a74adc8 Mon Sep 17 00:00:00 2001
From: Nikhil Gupta <nikhil.gupta_2@nxp.com>
Date: Mon, 13 May 2024 23:21:51 -0700
Subject: [PATCH] rfnm-add-support-to-compile-m7

Signed-off-by: Nikhil Gupta <nikhil.gupta_2@nxp.com>
---
 armgcc/CMakeLists.txt |  8 ++++----
 rfnm-gpio.h           | 42 ++++++++++++++++++++++++++++++++++++++++++
 rfnm_fe_generic.c     |  4 ++--
 rfnm_gpio.c           |  4 ++--
 rfnm_m7.h             |  6 +++---
 5 files changed, 53 insertions(+), 11 deletions(-)
 create mode 100644 rfnm-gpio.h

diff --git a/armgcc/CMakeLists.txt b/armgcc/CMakeLists.txt
index 16470c3..56eb038 100644
--- a/armgcc/CMakeLists.txt
+++ b/armgcc/CMakeLists.txt
@@ -22,9 +22,9 @@ SET(EXECUTABLE_OUTPUT_PATH ${ProjDirPath}/${CMAKE_BUILD_TYPE})
 SET(LIBRARY_OUTPUT_PATH ${ProjDirPath}/${CMAKE_BUILD_TYPE})
 
 
-project(gpt_capture)
+project(rfnm_m7_v0)
 
-set(MCUX_SDK_PROJECT_NAME gpt_capture.elf)
+set(MCUX_SDK_PROJECT_NAME rfnm_m7_v0.elf)
 
 include(${ProjDirPath}/flags.cmake)
 
@@ -107,6 +107,6 @@ target_link_libraries(${MCUX_SDK_PROJECT_NAME} PRIVATE nosys)
 TARGET_LINK_LIBRARIES(${MCUX_SDK_PROJECT_NAME} PRIVATE -Wl,--end-group)
 
 ADD_CUSTOM_COMMAND(TARGET ${MCUX_SDK_PROJECT_NAME} POST_BUILD COMMAND ${CMAKE_OBJCOPY}
--Obinary ${EXECUTABLE_OUTPUT_PATH}/${MCUX_SDK_PROJECT_NAME} ${EXECUTABLE_OUTPUT_PATH}/gpt_capture.bin)
+-Obinary ${EXECUTABLE_OUTPUT_PATH}/${MCUX_SDK_PROJECT_NAME} ${EXECUTABLE_OUTPUT_PATH}/rfnm_m7_v0.bin)
 
-add_custom_command(TARGET ${MCUX_SDK_PROJECT_NAME} POST_BUILD COMMAND scp ${EXECUTABLE_OUTPUT_PATH}/gpt_capture.elf root@10.0.0.149:/lib/firmware/rfnm_m7_v0.elf )
+#add_custom_command(TARGET ${MCUX_SDK_PROJECT_NAME} POST_BUILD COMMAND scp ${EXECUTABLE_OUTPUT_PATH}/rfnm_m7_v0.elf root@10.0.0.149:/lib/firmware/rfnm_m7_v0.elf )
diff --git a/rfnm-gpio.h b/rfnm-gpio.h
new file mode 100644
index 0000000..aec8bd5
--- /dev/null
+++ b/rfnm-gpio.h
@@ -0,0 +1,42 @@
+// SPDX-License-Identifier: (BSD-3-Clause OR GPL-2.0)
+
+#ifndef INCLUDE_LINUX_RFNM_GPIO_H_
+#define INCLUDE_LINUX_RFNM_GPIO_H_
+
+
+#define R_DBG_S_PRI_BANK 0
+#define R_DBG_S_PRI_NUM 8
+#define R_DBG_S_SEC_BANK 16
+#define R_DBG_S_SEC_NUM 24
+
+#define RFNM_DGB_GPIO4_0 ((4 << R_DBG_S_PRI_BANK) | (0 << R_DBG_S_PRI_NUM) | (4 << R_DBG_S_SEC_BANK) | (10 << R_DBG_S_SEC_NUM))
+#define RFNM_DGB_GPIO4_1 ((4 << R_DBG_S_PRI_BANK) | (1 << R_DBG_S_PRI_NUM) | (4 << R_DBG_S_SEC_BANK) | (11 << R_DBG_S_SEC_NUM))
+#define RFNM_DGB_GPIO4_2 ((4 << R_DBG_S_PRI_BANK) | (2 << R_DBG_S_PRI_NUM) | (4 << R_DBG_S_SEC_BANK) | (12 << R_DBG_S_SEC_NUM))
+#define RFNM_DGB_GPIO4_3 ((4 << R_DBG_S_PRI_BANK) | (3 << R_DBG_S_PRI_NUM) | (4 << R_DBG_S_SEC_BANK) | (13 << R_DBG_S_SEC_NUM))
+#define RFNM_DGB_GPIO4_4 ((4 << R_DBG_S_PRI_BANK) | (4 << R_DBG_S_PRI_NUM) | (4 << R_DBG_S_SEC_BANK) | (14 << R_DBG_S_SEC_NUM))
+#define RFNM_DGB_GPIO4_5 ((4 << R_DBG_S_PRI_BANK) | (5 << R_DBG_S_PRI_NUM) | (4 << R_DBG_S_SEC_BANK) | (15 << R_DBG_S_SEC_NUM))
+#define RFNM_DGB_GPIO4_6 ((4 << R_DBG_S_PRI_BANK) | (6 << R_DBG_S_PRI_NUM) | (4 << R_DBG_S_SEC_BANK) | (16 << R_DBG_S_SEC_NUM))
+#define RFNM_DGB_GPIO4_7 ((4 << R_DBG_S_PRI_BANK) | (7 << R_DBG_S_PRI_NUM) | (4 << R_DBG_S_SEC_BANK) | (17 << R_DBG_S_SEC_NUM))
+#define RFNM_DGB_GPIO5_16 ((5 << R_DBG_S_PRI_BANK) | (16 << R_DBG_S_PRI_NUM) | (5 << R_DBG_S_SEC_BANK) | (17 << R_DBG_S_SEC_NUM))
+#define RFNM_DGB_GPIO3_21 ((3 << R_DBG_S_PRI_BANK) | (21 << R_DBG_S_PRI_NUM) | (5 << R_DBG_S_SEC_BANK) | (2 << R_DBG_S_SEC_NUM))
+#define RFNM_DGB_GPIO4_8 ((4 << R_DBG_S_PRI_BANK) | (8 << R_DBG_S_PRI_NUM) | (4 << R_DBG_S_SEC_BANK) | (18 << R_DBG_S_SEC_NUM))
+#define RFNM_DGB_GPIO4_9 ((4 << R_DBG_S_PRI_BANK) | (9 << R_DBG_S_PRI_NUM) | (4 << R_DBG_S_SEC_BANK) | (19 << R_DBG_S_SEC_NUM))
+#define RFNM_DGB_GPIO2_3 ((2 << R_DBG_S_PRI_BANK) | (3 << R_DBG_S_PRI_NUM) | (2 << R_DBG_S_SEC_BANK) | (1 << R_DBG_S_SEC_NUM))
+#define RFNM_DGB_GPIO2_2 ((2 << R_DBG_S_PRI_BANK) | (2 << R_DBG_S_PRI_NUM) | (2 << R_DBG_S_SEC_BANK) | (0 << R_DBG_S_SEC_NUM))
+#define RFNM_DGB_GPIO3_22 ((3 << R_DBG_S_PRI_BANK) | (22 << R_DBG_S_PRI_NUM) | (3 << R_DBG_S_SEC_BANK) | (24 << R_DBG_S_SEC_NUM))
+#define RFNM_DGB_GPIO3_23 ((3 << R_DBG_S_PRI_BANK) | (23 << R_DBG_S_PRI_NUM) | (3 << R_DBG_S_SEC_BANK) | (25 << R_DBG_S_SEC_NUM))
+
+#define RFNM_DGB_GPIO4_22 ((4 << R_DBG_S_PRI_BANK) | (22 << R_DBG_S_PRI_NUM) | (4 << R_DBG_S_SEC_BANK) | (22 << R_DBG_S_SEC_NUM))
+#define RFNM_DGB_GPIO4_23 ((4 << R_DBG_S_PRI_BANK) | (23 << R_DBG_S_PRI_NUM) | (4 << R_DBG_S_SEC_BANK) | (23 << R_DBG_S_SEC_NUM))
+#define RFNM_DGB_GPIO4_31 ((4 << R_DBG_S_PRI_BANK) | (31 << R_DBG_S_PRI_NUM) | (4 << R_DBG_S_SEC_BANK) | (31 << R_DBG_S_SEC_NUM))
+
+// bit order is inverted in LA?
+#define RFNM_DGB_LA_FE_CLK ((6 << R_DBG_S_PRI_BANK) | (24 << R_DBG_S_PRI_NUM) | (6 << R_DBG_S_SEC_BANK) | (23 << R_DBG_S_SEC_NUM))
+
+
+void rfnm_gpio_set(uint8_t dgb_id, uint32_t gpio_map_id);
+void rfnm_gpio_clear(uint8_t dgb_id, uint32_t gpio_map_id);
+void rfnm_gpio_output(uint8_t dgb_id, uint32_t gpio_map_id);
+
+
+#endif
diff --git a/rfnm_fe_generic.c b/rfnm_fe_generic.c
index 61a1011..a69ccf5 100644
--- a/rfnm_fe_generic.c
+++ b/rfnm_fe_generic.c
@@ -8,7 +8,7 @@
 #include "fsl_common.h"
 
 #include "rfnm_m7.h"
-#include "/home/davide/imx-rfnm-bsp/build/tmp/work-shared/imx8mp-rfnm/kernel-source/include/linux/rfnm-gpio.h"
+#include "rfnm-gpio.h"
 
 
 
@@ -287,4 +287,4 @@ void rfnm_fe_trigger_latches(struct rfnm_m7_dgb * dgb_dt, int txrx) {
     }
 
 	
-}
\ No newline at end of file
+}
diff --git a/rfnm_gpio.c b/rfnm_gpio.c
index 6ff7314..5546291 100644
--- a/rfnm_gpio.c
+++ b/rfnm_gpio.c
@@ -8,7 +8,7 @@
 #include "fsl_common.h"
 #include "rfnm_m7.h"
 
-#include "/home/davide/imx-rfnm-bsp/build/tmp/work-shared/imx8mp-rfnm/kernel-source/include/linux/rfnm-gpio.h"
+#include "rfnm-gpio.h"
 
 
 volatile unsigned int *gpio[7];
@@ -93,4 +93,4 @@ void rfnm_gpio_init(void) {
 	// la9310
 	gpio[6] = (volatile unsigned int *) PCIE_GPIO_ADDR_FROM_M7;
 
-}
\ No newline at end of file
+}
diff --git a/rfnm_m7.h b/rfnm_m7.h
index 9fb12a1..5156eec 100644
--- a/rfnm_m7.h
+++ b/rfnm_m7.h
@@ -1,8 +1,8 @@
 #ifndef __H_RFNM_M7
 #define __H_RFNM_M7
 
-#define PCIE_CTRL_ADDR_OFFSET (0x1C00F740 - 0x18000000)
-#define PCIE_CTRL_ADDR_FROM_M7 (0xD0000000 + PCIE_CTRL_ADDR_OFFSET) // D400 F740
+#define PCIE_CTRL_ADDR_OFFSET (0x1C010B40 - 0x18000000)
+#define PCIE_CTRL_ADDR_FROM_M7 (0xD0000000 + PCIE_CTRL_ADDR_OFFSET) // D400 10B40
 #define PCIE_GPIO_ADDR_FROM_M7 (0xD0000000 + 0x2300000)
 #define VSPA_MEM_ADDR_OFFSET (0x1F400000 - 0x18000000)
 #define VSPA_MEM_ADDR_FROM_M7 (0xD0000000 + VSPA_MEM_ADDR_OFFSET)
@@ -152,4 +152,4 @@ int rfnm_fe_generic_init(struct rfnm_m7_dgb * dgb_dt);
 
 
 
-#endif
\ No newline at end of file
+#endif
-- 
2.25.1

