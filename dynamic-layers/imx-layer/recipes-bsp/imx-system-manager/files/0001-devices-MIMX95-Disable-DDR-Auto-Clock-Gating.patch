From 5120708d953889bfa29bdec7a2e8b77757dbcc44 Mon Sep 17 00:00:00 2001
From: Aziz Sellami <aziz.sellami@nxp.com>
Date: Fri, 30 Aug 2024 14:58:34 +0200
Subject: [PATCH] devices: MIMX95: Disable DDR Auto Clock Gating

DDR Auto Clock Gating Feature has an impact on real-time performance.
Let's disable this feature.

Signed-off-by: Aziz Sellami <aziz.sellami@nxp.com>
Upstream-Status: Pending
---
 configs/configtool.pl               | 14 ++++++++++++++
 configs/other/mx95rte.cfg           |  2 ++
 devices/MIMX95/system_MIMX95_cm33.c |  5 +++++
 3 files changed, 21 insertions(+)

diff --git a/configs/configtool.pl b/configs/configtool.pl
index df7bca4..3117ccb 100755
--- a/configs/configtool.pl
+++ b/configs/configtool.pl
@@ -2002,6 +2002,20 @@ sub generate_board
 	print $out sprintf("#define %*s %sU\n", -$w,
 		'BOARD_I2C_BAUDRATE', $boardI2cBaudrate);
 
+    # Disable DDR Auto Clock Gating
+	if (my $def = &get_define('DISABLE_DDR_AUTO_CLK_GATING_ON_INIT', $cfgRef))
+	{
+		print $out '/*! Config for DDR Auto Clock Gating at system init */' . "\n";
+		print $out sprintf("#define %*s %s\n", -$w,
+			'BOARD_DISABLE_DDR_AUTO_CLK_GATING_ON_INIT', $def);
+	}
+	else
+	{
+		print $out '/*! Config for DDR Auto Clock Gating at system init */' . "\n";
+		print $out sprintf("#define %*s %s\n", -$w,
+			'BOARD_DISABLE_DDR_AUTO_CLK_GATING_ON_INIT', 0);
+	}
+
     # Output footer
     print $out &footer('BOARD');
 
diff --git a/configs/other/mx95rte.cfg b/configs/other/mx95rte.cfg
index 54acd1e..95d3390 100755
--- a/configs/other/mx95rte.cfg
+++ b/configs/other/mx95rte.cfg
@@ -37,6 +37,8 @@ DOX     name=MX95RTE, desc="i.MX95 EVK Real-time-edge Configuration Data"
 
 include ../../devices/MIMX95/configtool/device.cfg
 
+DISABLE_DDR_AUTO_CLK_GATING_ON_INIT    1
+
 #==========================================================================#
 # Board                                                                    #
 #==========================================================================#
diff --git a/devices/MIMX95/system_MIMX95_cm33.c b/devices/MIMX95/system_MIMX95_cm33.c
index f8fe8f0..f0a223b 100755
--- a/devices/MIMX95/system_MIMX95_cm33.c
+++ b/devices/MIMX95/system_MIMX95_cm33.c
@@ -78,6 +78,11 @@ void SystemInit(void)
     /* Disable all SRC boot reset holds */
     SRC_GEN->SCR = 0xFFFFFFFFU;
 
+#if defined(BOARD_DISABLE_DDR_AUTO_CLK_GATING_ON_INIT) && (BOARD_DISABLE_DDR_AUTO_CLK_GATING_ON_INIT != 0)
+    /* Disable DDR Auto Clock Gating */
+    BLK_CTRL_DDRMIX->AUTO_CG_CTRL &= ~(BLK_CTRL_DDRMIX_AUTO_CG_CTRL_AUTO_CG_ENA_MASK);
+#endif
+
     /* Mask reset sources handled by SM */
     SRC_GEN->SRMASK = (1UL << RST_REASON_CM7_LOCKUP) | 
                       (1UL << RST_REASON_CM7_SWREQ) |
-- 
2.43.0

