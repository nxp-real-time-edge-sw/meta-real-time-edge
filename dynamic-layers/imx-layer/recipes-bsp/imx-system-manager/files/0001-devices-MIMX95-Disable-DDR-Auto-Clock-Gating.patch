From 986802c9ffbe47843343995f34efbdf836f0f0a1 Mon Sep 17 00:00:00 2001
From: Aziz Sellami <aziz.sellami@nxp.com>
Date: Fri, 30 Aug 2024 14:58:34 +0200
Subject: [PATCH 1/4] devices: MIMX95: Disable DDR Auto Clock Gating

DDR Auto Clock Gating Feature has an impact on real-time performance.
Let's disable this feature.

Signed-off-by: Aziz Sellami <aziz.sellami@nxp.com>
Upstream-Status: Pending
---
 configs/configtool.pl               | 14 ++++++++++++++
 configs/other/mx95rte.cfg           |  2 ++
 devices/MIMX95/system_MIMX95_cm33.c |  5 +++++
 3 files changed, 21 insertions(+)

diff --git a/configs/configtool.pl b/configs/configtool.pl
index b4f133f9..2202019a 100755
--- a/configs/configtool.pl
+++ b/configs/configtool.pl
@@ -2038,6 +2038,20 @@ sub generate_board
 	print $out sprintf("#define %*s %sU\n", -$w,
 		'BOARD_I2C_BAUDRATE', $boardI2cBaudrate);
 
+    # Disable DDR Auto Clock Gating
+	if (my $def = &get_define('DISABLE_DDR_AUTO_CLK_GATING_ON_INIT', $cfgRef))
+	{
+		print $out '/*! Config for DDR Auto Clock Gating at system init */' . "\n";
+		print $out sprintf("#define %*s %s\n", -$w,
+			'BOARD_DISABLE_DDR_AUTO_CLK_GATING_ON_INIT', $def);
+	}
+	else
+	{
+		print $out '/*! Config for DDR Auto Clock Gating at system init */' . "\n";
+		print $out sprintf("#define %*s %s\n", -$w,
+			'BOARD_DISABLE_DDR_AUTO_CLK_GATING_ON_INIT', 0);
+	}
+
     # Output footer
     print $out &footer('BOARD');
 
diff --git a/configs/other/mx95rte.cfg b/configs/other/mx95rte.cfg
index 0a2bb0fd..c416ab57 100755
--- a/configs/other/mx95rte.cfg
+++ b/configs/other/mx95rte.cfg
@@ -58,6 +58,8 @@ PRIV:               api=priv
 ALL:                api=all
 READONLY:           perm=ro
 
+DISABLE_DDR_AUTO_CLK_GATING_ON_INIT    1
+
 #==========================================================================#
 # ELE Domain                                                               #
 #==========================================================================#
diff --git a/devices/MIMX95/system_MIMX95_cm33.c b/devices/MIMX95/system_MIMX95_cm33.c
index 34808921..226a8b0f 100755
--- a/devices/MIMX95/system_MIMX95_cm33.c
+++ b/devices/MIMX95/system_MIMX95_cm33.c
@@ -78,6 +78,11 @@ void SystemInit(void)
     /* Disable all SRC boot reset holds */
     SRC_GEN->SCR = 0xFFFFFFFFU;
 
+#if defined(BOARD_DISABLE_DDR_AUTO_CLK_GATING_ON_INIT) && (BOARD_DISABLE_DDR_AUTO_CLK_GATING_ON_INIT != 0)
+    /* Disable DDR Auto Clock Gating */
+    BLK_CTRL_DDRMIX->AUTO_CG_CTRL &= ~(BLK_CTRL_DDRMIX_AUTO_CG_CTRL_AUTO_CG_ENA_MASK);
+#endif
+
     /* Mask reset sources handled by SM */
     SRC_GEN->SRMASK = (1UL << RST_REASON_CM7_LOCKUP) | 
                       (1UL << RST_REASON_CM7_SWREQ) |
-- 
2.43.0

